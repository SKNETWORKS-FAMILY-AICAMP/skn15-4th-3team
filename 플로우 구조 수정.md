
```mermaid

flowchart LR
  subgraph Ingestion[인덱싱(사전 준비)]
    A[보험사 약관 PDF들] --> L1[PyPDFLoader]
    L1 --> S1[문서 분할\nSemantic / Recursive]
    S1 --> E1[OpenAIEmbeddings]
    E1 --> PGV[(PostgreSQL + pgvector)\n여러 Collection]
    U1[사용자 업로드 파일(pdf/txt)] --> L2[PDFPlumber/텍스트 로더]
    L2 --> S2[문서 분할]
    S2 --> E2[OpenAIEmbeddings(캐시)]
    E2 --> F[(FAISS - 세션 임시 벡터DB)]
  end

  subgraph App[질의 응답(런타임)]
    UQ[사용자 질문 + 히스토리\n(Streamlit UI)]
    UQ --> ER[EnsembleRetriever\nMMR(k, fetch_k, lambda)]
    ER -->|Top‑k| PGV
    ER -->|Top‑k| F
    PGV --> R[관련 문서들]
    F --> R
    R --> FMT[format_docs\n(출처/페이지 포함)]
    FMT --> PROMPT[ChatPromptTemplate\n(서식·표·추천도·출처)]
    PROMPT --> LLM[OpenAI Chat Model\n(gpt-4.x / 4o-mini)]
    LLM --> POST[render_answer\n줄간격/불릿/배지 정리]
    POST --> OUT[스트리밍 응답\n(Streamlit Chat)]
  end

  style Ingestion fill:#f7fcff,stroke:#79b8ff
  style App fill:#f9f9f9,stroke:#d0d7de

```

